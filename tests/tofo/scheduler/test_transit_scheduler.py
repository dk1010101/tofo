
from yaml import load
try:
    from yaml import CLoader as Loader
except ImportError:
    from yaml import Loader

import astropy.units as u
from astropy.time import Time

from astroplan.scheduling import Transitioner

import pytest

from tofo.target import Target
from tofo.observatory import Observatory
from tofo.scheduler.transit_scheduler import TransitScheduler


@pytest.fixture
def obs(shared_datadir):
    with open(shared_datadir / "observatory.yaml", "r", encoding="utf-8") as f:
        obs_js = load(f, Loader=Loader)
    o = Observatory(obs_js)
    o.sources_cache_file_name = shared_datadir / o.sources_cache_file_name
    yield o

@pytest.fixture
def transitioner():
    yield Transitioner(5*u.deg/u.second)  # reasonable slew time but not sure if this makes sense for Palomar Hale

def test_simple_schedule(obs, transitioner):  # pylint:disable=redefined-outer-name
    
    target_data = [
        ('CoRoT-1b', 0.5, 2456268.99119, 1.50896877, 2.51, '06:48:19.1723', '-03:06:07.710'),
        ('Gaia-2b', 0.5, 2458843.98875, 3.6915224, 2.83, '07:22:56.4611', '+67:15:09.190'),
        ('HAT-P-56b', 0.5, 2458459.75023, 2.790825, 2.3, '06:43:23.5327', '+27:15:08.212'),
        ('HAT-P-61b', 0.5, 2457851.21119, 1.90231289, 1.67, '05:01:55.2577', '+50:07:52.574'),
        ('HAT-P-68b', 0.5, 2458140.34562, 2.29840555, 2.1, '07:53:55.9827', '+23:56:17.611'),
        ('HATS-55b', 0.5, 2459229.3389, 4.2041844, 2.63, '07:37:08.0193', '-32:45:19.515'),
        ('HD93963Ac', 0.5, 2458902.87274, 3.6451398, 2.27, '10:51:06.5136', '+25:38:28.189'),
        ('KELT-7b', 0.5, 2459109.138447, 2.7347656, 3.49, '05:13:10.9287', '+33:19:05.403'),
        ('KPS-1b', 0.5, 2458888.7872, 1.70632513, 1.69, '11:00:40.1821', '+64:57:50.345'),
        ('LTT3780b', 0.5, 2458543.9115, 0.768448, 0.81, '10:18:35.1370', '-11:43:00.241'),
        ('NGTS-10b', 0.5, 2457518.84377, 0.7668944, 1.09, '06:07:29.3376', '-25:35:41.676'),
        ('Qatar-2b', 0.5, 2457008.18278, 1.337116562, 1.84, '13:50:37.4100', '-06:48:14.419'),
        ('Qatar-9b', 0.5, 2459275.4837, 1.54077512, 1.87, '10:42:59.5933', '+60:57:51.159'),
        ('TOI-561b', 0.5, 2458517.498, 0.446578, 1.33, '09:52:44.5490', '+06:12:58.924'),
        ('TOI-1442b', 0.5, 2458683.4523, 0.4090677, 0.63, '19:09:09.7936', '+74:10:20.222'),
        ('TOI-1468b', 0.5, 2458765.68079, 1.8805136, 1.07, '01:06:36.9754', '+19:13:33.163'),
        ('TOI-1728b', 0.5, 2459087.67385, 3.491405, 1.91, '08:02:26.5503', '+64:47:48.931'),
        ('TOI-2076b', 0.5, 2458805.85425, 10.355489, 3.33, '14:29:34.2426', '+39:47:25.543'),
        ('TOI-2152Ab', 0.5, 2458927.6498, 3.3773512, 3.65, '01:45:21.2186', '+77:47:24.626'),
        ('TOI-2445b', 0.5, 2459144.5697, 0.3711281, 0.56, '02:53:15.8181', '+00:03:08.784'),
        ('WASP-11b', 0.5, 2456646.984352, 3.72247919, 2.58, '03:09:28.5427', '+30:40:24.868'),
        ('WASP-34b', 0.5, 2458654.3645, 4.31768411, 2.11, '11:01:35.8978', '-23:51:38.384'),
        ('WASP-43b', 0.5, 2457202.184881, 0.813474056, 1.23, '10:19:38.0089', '-09:48:22.603'),
        ('WASP-85Ab', 0.5, 2456929.798775, 2.655674403, 2.64, '11:43:38.0162', '+06:33:49.419'),
        ('WASP-142b', 0.5, 2458032.1611, 2.0528705, 2.76, '09:22:01.5338', '-23:56:46.202'),
    ]
    targets = [Target(obs, 
                      t[0], 
                      "", 
                      t[5], 
                      t[6], 
                      Time(t[2], format='jd'), 
                      t[3]*u.day, 
                      t[4]*u.hour, 
                      priority=t[1], 
                      is_exoplanet=True) 
               for t in target_data]

    start_time, end_time = (Time("2025-01-24 09:41"), Time("2025-01-26 22:19"))  # utc but random time to get a lot of targets
    s = TransitScheduler(obs, targets, start_time, end_time, transitioner=transitioner)
    
    all_sequences = s.possible_sequences
    
    assert all_sequences == [
        ['HD93963Ac', 'Qatar-9b'],
        ['HD93963Ac', 'Qatar-9b', 'WASP-142b'],
        ['HD93963Ac', 'Qatar-9b', 'HAT-P-61b'],
        ['HD93963Ac', 'Qatar-9b', 'TOI-2076b'],
        ['HD93963Ac', 'Qatar-9b', 'KPS-1b'],
        ['HD93963Ac', 'Qatar-9b', 'WASP-34b'],
        ['HD93963Ac', 'Qatar-9b', 'WASP-43b'],
        ['HD93963Ac', 'Qatar-9b', 'LTT3780b'],
        ['HD93963Ac', 'Qatar-9b', 'TOI-1442b'],
        ['HD93963Ac', 'TOI-1728b'],
        ['HD93963Ac', 'TOI-1728b', 'WASP-142b'],
        ['HD93963Ac', 'TOI-1728b', 'HAT-P-61b'],
        ['HD93963Ac', 'TOI-1728b', 'TOI-2076b'],
        ['HD93963Ac', 'TOI-1728b', 'KPS-1b'],
        ['HD93963Ac', 'TOI-1728b', 'WASP-34b'],
        ['HD93963Ac', 'TOI-1728b', 'WASP-43b'],
        ['HD93963Ac', 'TOI-1728b', 'LTT3780b'],
        ['HD93963Ac', 'TOI-1728b', 'TOI-1442b'],
        ['HD93963Ac', 'NGTS-10b'],
        ['HD93963Ac', 'NGTS-10b', 'WASP-85Ab'],
        ['HD93963Ac', 'NGTS-10b', 'WASP-142b'],
        ['HD93963Ac', 'NGTS-10b', 'HAT-P-61b'],
        ['HD93963Ac', 'NGTS-10b', 'TOI-2076b'],
        ['HD93963Ac', 'NGTS-10b', 'KPS-1b'],
        ['HD93963Ac', 'NGTS-10b', 'WASP-34b'],
        ['HD93963Ac', 'NGTS-10b', 'WASP-43b'],
        ['HD93963Ac', 'NGTS-10b', 'LTT3780b'],
        ['HD93963Ac', 'NGTS-10b', 'TOI-1442b'],
        ['HD93963Ac', 'TOI-2152Ab'],
        ['HD93963Ac', 'TOI-2152Ab', 'LTT3780b'],
        ['HD93963Ac', 'TOI-2152Ab', 'TOI-1442b'],
        ['HD93963Ac', 'KELT-7b'],
        ['HD93963Ac', 'KELT-7b', 'TOI-1442b'],
        ['HD93963Ac', 'TOI-2445b'],
        ['HD93963Ac', 'TOI-2445b', 'WASP-142b'],
        ['HD93963Ac', 'TOI-2445b', 'HAT-P-61b'],
        ['HD93963Ac', 'TOI-2445b', 'TOI-2076b'],
        ['HD93963Ac', 'TOI-2445b', 'KPS-1b'],
        ['HD93963Ac', 'TOI-2445b', 'WASP-34b'],
        ['HD93963Ac', 'TOI-2445b', 'WASP-43b'],
        ['HD93963Ac', 'TOI-2445b', 'LTT3780b'],
        ['HD93963Ac', 'TOI-2445b', 'TOI-1442b'],
        ['HD93963Ac', 'TOI-1468b'],
        ['HD93963Ac', 'TOI-1468b', 'KPS-1b'],
        ['HD93963Ac', 'TOI-1468b', 'WASP-34b'],
        ['HD93963Ac', 'TOI-1468b', 'WASP-43b'],
        ['HD93963Ac', 'TOI-1468b', 'LTT3780b'],
        ['HD93963Ac', 'TOI-1468b', 'TOI-1442b'],
        ['HD93963Ac', 'WASP-11b'],
        ['HD93963Ac', 'WASP-11b', 'WASP-43b'],
        ['HD93963Ac', 'WASP-11b', 'LTT3780b'],
        ['HD93963Ac', 'WASP-11b', 'TOI-1442b'],
        ['HD93963Ac', 'HAT-P-68b'],
        ['HD93963Ac', 'HAT-P-68b', 'WASP-34b'],
        ['HD93963Ac', 'HAT-P-68b', 'WASP-43b'],
        ['HD93963Ac', 'HAT-P-68b', 'LTT3780b'],
        ['HD93963Ac', 'HAT-P-68b', 'TOI-1442b'],
        ['HD93963Ac', 'HAT-P-56b'],
        ['HD93963Ac', 'HAT-P-56b', 'LTT3780b'],
        ['HD93963Ac', 'HAT-P-56b', 'TOI-1442b'],
        ['HD93963Ac', 'HATS-55b'],
        ['HD93963Ac', 'HATS-55b', 'TOI-1442b'],
        ['HD93963Ac', 'Gaia-2b'],
        ['HD93963Ac', 'CoRoT-1b'],
        ['HD93963Ac', 'WASP-85Ab'],
        ['HD93963Ac', 'WASP-142b'],
        ['HD93963Ac', 'HAT-P-61b'],
        ['HD93963Ac', 'TOI-2076b'],
        ['HD93963Ac', 'KPS-1b'],
        ['HD93963Ac', 'WASP-34b'],
        ['HD93963Ac', 'WASP-43b'],
        ['HD93963Ac', 'LTT3780b'],
        ['HD93963Ac', 'TOI-1442b'],
        ['TOI-561b', 'Qatar-9b'],
        ['TOI-561b', 'Qatar-9b', 'WASP-142b'],
        ['TOI-561b', 'Qatar-9b', 'HAT-P-61b'],
        ['TOI-561b', 'Qatar-9b', 'TOI-2076b'],
        ['TOI-561b', 'Qatar-9b', 'KPS-1b'],
        ['TOI-561b', 'Qatar-9b', 'WASP-34b'],
        ['TOI-561b', 'Qatar-9b', 'WASP-43b'],
        ['TOI-561b', 'Qatar-9b', 'LTT3780b'],
        ['TOI-561b', 'Qatar-9b', 'TOI-1442b'],
        ['TOI-561b', 'TOI-1728b'],
        ['TOI-561b', 'TOI-1728b', 'WASP-142b'],
        ['TOI-561b', 'TOI-1728b', 'HAT-P-61b'],
        ['TOI-561b', 'TOI-1728b', 'TOI-2076b'],
        ['TOI-561b', 'TOI-1728b', 'KPS-1b'],
        ['TOI-561b', 'TOI-1728b', 'WASP-34b'],
        ['TOI-561b', 'TOI-1728b', 'WASP-43b'],
        ['TOI-561b', 'TOI-1728b', 'LTT3780b'],
        ['TOI-561b', 'TOI-1728b', 'TOI-1442b'],
        ['TOI-561b', 'NGTS-10b'],
        ['TOI-561b', 'NGTS-10b', 'WASP-85Ab'],
        ['TOI-561b', 'NGTS-10b', 'WASP-142b'],
        ['TOI-561b', 'NGTS-10b', 'HAT-P-61b'],
        ['TOI-561b', 'NGTS-10b', 'TOI-2076b'],
        ['TOI-561b', 'NGTS-10b', 'KPS-1b'],
        ['TOI-561b', 'NGTS-10b', 'WASP-34b'],
        ['TOI-561b', 'NGTS-10b', 'WASP-43b'],
        ['TOI-561b', 'NGTS-10b', 'LTT3780b'],
        ['TOI-561b', 'NGTS-10b', 'TOI-1442b'],
        ['TOI-561b', 'TOI-2152Ab'],
        ['TOI-561b', 'TOI-2152Ab', 'LTT3780b'],
        ['TOI-561b', 'TOI-2152Ab', 'TOI-1442b'],
        ['TOI-561b', 'KELT-7b'],
        ['TOI-561b', 'KELT-7b', 'TOI-1442b'],
        ['TOI-561b', 'TOI-2445b'],
        ['TOI-561b', 'TOI-2445b', 'WASP-142b'],
        ['TOI-561b', 'TOI-2445b', 'HAT-P-61b'],
        ['TOI-561b', 'TOI-2445b', 'TOI-2076b'],
        ['TOI-561b', 'TOI-2445b', 'KPS-1b'],
        ['TOI-561b', 'TOI-2445b', 'WASP-34b'],
        ['TOI-561b', 'TOI-2445b', 'WASP-43b'],
        ['TOI-561b', 'TOI-2445b', 'LTT3780b'],
        ['TOI-561b', 'TOI-2445b', 'TOI-1442b'],
        ['TOI-561b', 'TOI-1468b'],
        ['TOI-561b', 'TOI-1468b', 'KPS-1b'],
        ['TOI-561b', 'TOI-1468b', 'WASP-34b'],
        ['TOI-561b', 'TOI-1468b', 'WASP-43b'],
        ['TOI-561b', 'TOI-1468b', 'LTT3780b'],
        ['TOI-561b', 'TOI-1468b', 'TOI-1442b'],
        ['TOI-561b', 'WASP-11b'],
        ['TOI-561b', 'WASP-11b', 'WASP-43b'],
        ['TOI-561b', 'WASP-11b', 'LTT3780b'],
        ['TOI-561b', 'WASP-11b', 'TOI-1442b'],
        ['TOI-561b', 'HAT-P-68b'],
        ['TOI-561b', 'HAT-P-68b', 'WASP-34b'],
        ['TOI-561b', 'HAT-P-68b', 'WASP-43b'],
        ['TOI-561b', 'HAT-P-68b', 'LTT3780b'],
        ['TOI-561b', 'HAT-P-68b', 'TOI-1442b'],
        ['TOI-561b', 'HAT-P-56b'],
        ['TOI-561b', 'HAT-P-56b', 'LTT3780b'],
        ['TOI-561b', 'HAT-P-56b', 'TOI-1442b'],
        ['TOI-561b', 'HATS-55b'],
        ['TOI-561b', 'HATS-55b', 'TOI-1442b'],
        ['TOI-561b', 'Gaia-2b'],
        ['TOI-561b', 'CoRoT-1b'],
        ['TOI-561b', 'WASP-85Ab'],
        ['TOI-561b', 'WASP-142b'],
        ['TOI-561b', 'HAT-P-61b'],
        ['TOI-561b', 'TOI-2076b'],
        ['TOI-561b', 'KPS-1b'],
        ['TOI-561b', 'WASP-34b'],
        ['TOI-561b', 'WASP-43b'],
        ['TOI-561b', 'LTT3780b'],
        ['TOI-561b', 'TOI-1442b'],
        ['Qatar-2b', 'Qatar-9b'],
        ['Qatar-2b', 'Qatar-9b', 'WASP-142b'],
        ['Qatar-2b', 'Qatar-9b', 'HAT-P-61b'],
        ['Qatar-2b', 'Qatar-9b', 'TOI-2076b'],
        ['Qatar-2b', 'Qatar-9b', 'KPS-1b'],
        ['Qatar-2b', 'Qatar-9b', 'WASP-34b'],
        ['Qatar-2b', 'Qatar-9b', 'WASP-43b'],
        ['Qatar-2b', 'Qatar-9b', 'LTT3780b'],
        ['Qatar-2b', 'Qatar-9b', 'TOI-1442b'],
        ['Qatar-2b', 'TOI-1728b'],
        ['Qatar-2b', 'TOI-1728b', 'WASP-142b'],
        ['Qatar-2b', 'TOI-1728b', 'HAT-P-61b'],
        ['Qatar-2b', 'TOI-1728b', 'TOI-2076b'],
        ['Qatar-2b', 'TOI-1728b', 'KPS-1b'],
        ['Qatar-2b', 'TOI-1728b', 'WASP-34b'],
        ['Qatar-2b', 'TOI-1728b', 'WASP-43b'],
        ['Qatar-2b', 'TOI-1728b', 'LTT3780b'],
        ['Qatar-2b', 'TOI-1728b', 'TOI-1442b'],
        ['Qatar-2b', 'NGTS-10b'],
        ['Qatar-2b', 'NGTS-10b', 'WASP-85Ab'],
        ['Qatar-2b', 'NGTS-10b', 'WASP-142b'],
        ['Qatar-2b', 'NGTS-10b', 'HAT-P-61b'],
        ['Qatar-2b', 'NGTS-10b', 'TOI-2076b'],
        ['Qatar-2b', 'NGTS-10b', 'KPS-1b'],
        ['Qatar-2b', 'NGTS-10b', 'WASP-34b'],
        ['Qatar-2b', 'NGTS-10b', 'WASP-43b'],
        ['Qatar-2b', 'NGTS-10b', 'LTT3780b'],
        ['Qatar-2b', 'NGTS-10b', 'TOI-1442b'],
        ['Qatar-2b', 'TOI-2152Ab'],
        ['Qatar-2b', 'TOI-2152Ab', 'LTT3780b'],
        ['Qatar-2b', 'TOI-2152Ab', 'TOI-1442b'],
        ['Qatar-2b', 'KELT-7b'],
        ['Qatar-2b', 'KELT-7b', 'TOI-1442b'],
        ['Qatar-2b', 'TOI-2445b'],
        ['Qatar-2b', 'TOI-2445b', 'WASP-142b'],
        ['Qatar-2b', 'TOI-2445b', 'HAT-P-61b'],
        ['Qatar-2b', 'TOI-2445b', 'TOI-2076b'],
        ['Qatar-2b', 'TOI-2445b', 'KPS-1b'],
        ['Qatar-2b', 'TOI-2445b', 'WASP-34b'],
        ['Qatar-2b', 'TOI-2445b', 'WASP-43b'],
        ['Qatar-2b', 'TOI-2445b', 'LTT3780b'],
        ['Qatar-2b', 'TOI-2445b', 'TOI-1442b'],
        ['Qatar-2b', 'TOI-1468b'],
        ['Qatar-2b', 'TOI-1468b', 'KPS-1b'],
        ['Qatar-2b', 'TOI-1468b', 'WASP-34b'],
        ['Qatar-2b', 'TOI-1468b', 'WASP-43b'],
        ['Qatar-2b', 'TOI-1468b', 'LTT3780b'],
        ['Qatar-2b', 'TOI-1468b', 'TOI-1442b'],
        ['Qatar-2b', 'WASP-11b'],
        ['Qatar-2b', 'WASP-11b', 'WASP-43b'],
        ['Qatar-2b', 'WASP-11b', 'LTT3780b'],
        ['Qatar-2b', 'WASP-11b', 'TOI-1442b'],
        ['Qatar-2b', 'HAT-P-68b'],
        ['Qatar-2b', 'HAT-P-68b', 'WASP-34b'],
        ['Qatar-2b', 'HAT-P-68b', 'WASP-43b'],
        ['Qatar-2b', 'HAT-P-68b', 'LTT3780b'],
        ['Qatar-2b', 'HAT-P-68b', 'TOI-1442b'],
        ['Qatar-2b', 'HAT-P-56b'],
        ['Qatar-2b', 'HAT-P-56b', 'LTT3780b'],
        ['Qatar-2b', 'HAT-P-56b', 'TOI-1442b'],
        ['Qatar-2b', 'HATS-55b'],
        ['Qatar-2b', 'HATS-55b', 'TOI-1442b'],
        ['Qatar-2b', 'Gaia-2b'],
        ['Qatar-2b', 'CoRoT-1b'],
        ['Qatar-2b', 'WASP-85Ab'],
        ['Qatar-2b', 'WASP-142b'],
        ['Qatar-2b', 'HAT-P-61b'],
        ['Qatar-2b', 'TOI-2076b'],
        ['Qatar-2b', 'KPS-1b'],
        ['Qatar-2b', 'WASP-34b'],
        ['Qatar-2b', 'WASP-43b'],
        ['Qatar-2b', 'LTT3780b'],
        ['Qatar-2b', 'TOI-1442b'],
        ['Qatar-9b', 'WASP-142b'],
        ['Qatar-9b', 'HAT-P-61b'],
        ['Qatar-9b', 'TOI-2076b'],
        ['Qatar-9b', 'KPS-1b'],
        ['Qatar-9b', 'WASP-34b'],
        ['Qatar-9b', 'WASP-43b'],
        ['Qatar-9b', 'LTT3780b'],
        ['Qatar-9b', 'TOI-1442b'],
        ['TOI-1728b', 'WASP-142b'],
        ['TOI-1728b', 'HAT-P-61b'],
        ['TOI-1728b', 'TOI-2076b'],
        ['TOI-1728b', 'KPS-1b'],
        ['TOI-1728b', 'WASP-34b'],
        ['TOI-1728b', 'WASP-43b'],
        ['TOI-1728b', 'LTT3780b'],
        ['TOI-1728b', 'TOI-1442b'],
        ['NGTS-10b', 'WASP-85Ab'],
        ['NGTS-10b', 'WASP-142b'],
        ['NGTS-10b', 'HAT-P-61b'],
        ['NGTS-10b', 'TOI-2076b'],
        ['NGTS-10b', 'KPS-1b'],
        ['NGTS-10b', 'WASP-34b'],
        ['NGTS-10b', 'WASP-43b'],
        ['NGTS-10b', 'LTT3780b'],
        ['NGTS-10b', 'TOI-1442b'],
        ['TOI-2152Ab', 'LTT3780b'],
        ['TOI-2152Ab', 'TOI-1442b'],
        ['KELT-7b', 'TOI-1442b'],
        ['TOI-2445b', 'WASP-142b'],
        ['TOI-2445b', 'HAT-P-61b'],
        ['TOI-2445b', 'TOI-2076b'],
        ['TOI-2445b', 'KPS-1b'],
        ['TOI-2445b', 'WASP-34b'],
        ['TOI-2445b', 'WASP-43b'],
        ['TOI-2445b', 'LTT3780b'],
        ['TOI-2445b', 'TOI-1442b'],
        ['TOI-1468b', 'KPS-1b'],
        ['TOI-1468b', 'WASP-34b'],
        ['TOI-1468b', 'WASP-43b'],
        ['TOI-1468b', 'LTT3780b'],
        ['TOI-1468b', 'TOI-1442b'],
        ['WASP-11b', 'WASP-43b'],
        ['WASP-11b', 'LTT3780b'],
        ['WASP-11b', 'TOI-1442b'],
        ['HAT-P-68b', 'WASP-34b'],
        ['HAT-P-68b', 'WASP-43b'],
        ['HAT-P-68b', 'LTT3780b'],
        ['HAT-P-68b', 'TOI-1442b'],
        ['HAT-P-56b', 'LTT3780b'],
        ['HAT-P-56b', 'TOI-1442b'],
        ['HATS-55b', 'TOI-1442b']]
